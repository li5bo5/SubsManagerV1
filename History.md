# SubsManager 开发历史

## 1. [2024-02-27] 基础框架搭建

### 1.1 项目初始化
- 创建项目基本目录结构
- 设置配置管理系统
- 实现数据持久化存储
- 添加日志记录系统

### 1.2 Docker支持
- 创建多阶段构建的Dockerfile
- 支持ARM架构（linux/arm/v7）
- 配置数据卷挂载
- 暴露服务端口（3355）

## 2. [2024-02-27] 日志系统实现

### 2.1 日志功能特性
- 支持多种日志级别（INFO、ERROR、SUCCESS、WARNING）
- 实现内存缓存最近1000条日志记录
- 提供文件持久化存储
- 实现线程安全的日志操作
- 提供 `/api/logs` 接口用于获取日志记录

### 2.2 日志类型支持
- 订阅导入日志（导入完成，订阅名称，节点数量）
- 订阅整合日志（整合完成，整合订阅数量）
- 订阅删除日志（删除完成，删除的订阅名称）
- 节点测速日志（测速完成，总节点数，延迟测速节点数，丢弃节点数，下载测速节点数）
- 节点优选日志（优选条件，符合条件节点数量）
- 优选订阅日志（生成完成，订阅地址）
- 错误日志（详细错误信息）
- 普通信息日志
- 解析错误日志（订阅名称，节点类型，错误详情）

### 2.3 技术实现
- 使用 Go 标准库 `log` 包实现基础日志功能
- 使用 `sync.RWMutex` 确保并发安全
- 使用 JSON 格式存储日志内容，便于解析和展示
- 实现了日志轮转，保持最新的1000条日志记录

## 3. [2024-02-27] 订阅导入功能实现

### 3.1 订阅解析功能
1. 支持多种订阅格式：
   - Base64编码的订阅
   - YAML格式（OpenClash）
   - JSON格式（OpenClash兼容）

2. 支持的节点类型：
   - Vmess
   - Shadowsocks
   - Hysteria2
   - Trojan

3. 节点信息解析：
   - 服务器地址
   - 端口
   - 协议类型
   - 别名
   - 分组信息

### 3.2 API接口实现
- POST /api/subscriptions - 导入订阅
- GET /api/subscriptions - 获取所有订阅
- DELETE /api/subscriptions/:id - 删除订阅

### 3.3 错误处理和日志
1. 解析错误统计：
   - 按节点类型统计解析失败数量
   - 记录总节点数和成功数
   - 详细的错误原因记录

### 3.4 数据存储
1. 文件系统存储：
   - 订阅信息持久化
   - 节点信息持久化
   - 自动创建数据目录

## 4. [2024-02-27] 订阅管理功能实现

### 4.1 订阅列表功能
- 实现订阅信息的持久化存储
- 提供订阅列表查询接口
- 支持订阅信息的增删改查
- 订阅信息包含：
  - 订阅ID
  - 订阅名称
  - 订阅链接
  - 节点数量
  - 订阅类型
  - 更新时间
  - 节点列表

### 4.2 订阅整合功能
- 实现多个订阅的节点整合
- 支持节点去重（基于类型、服务器、端口）
- 提供整合后的节点列表
- 记录整合操作日志
- 生成OpenClash格式的YAML文件：
  - 文件命名格式：Sub-Input-MM-DD-HH-mm.yaml
  - 支持节点类型：vmess、ss、hysteria2、trojan
  - 自动配置节点特定参数
- 整合结果展示：
  - 整合时间
  - 订阅文件URL（支持本地访问）
  - 节点总数统计

### 4.3 API接口
- GET /api/subscription/list - 获取订阅列表
- DELETE /api/subscription/delete - 删除指定订阅
- POST /api/subscription/merge - 整合所有订阅节点
  - 请求参数：订阅ID列表
  - 返回数据：
    - 整合时间
    - 文件访问地址
    - 节点总数

### 4.4 数据结构优化
- 设计订阅信息结构（Subscription）
- 设计节点信息结构（Node）
- 实现线程安全的数据操作
- 支持JSON格式的数据序列化
- 新增整合结果结构（MergeResult）：
  - 整合时间戳
  - 文件URL
  - 节点计数

## 5. [2024-02-27] 节点测试功能实现

### 5.1 节点导入功能
- YAML文件解析：
  - 支持读取整合后的"Sub-Input-MM-DD-HH-mm.yaml"文件
  - 解析OpenClash格式的节点配置
  - 支持所有节点类型（vmess、ss、hysteria2、trojan）

- 节点信息展示：
  - 序号（自动生成）
  - 节点类型
  - 节点别名
  - 服务器地址
  - 端口
  - 传输协议
  - 订阅分组

- API接口实现：
  - POST /api/nodes/import - 导入节点
    - 请求参数：YAML文件路径
    - 返回数据：导入的节点列表
  - GET /api/nodes/list - 获取节点列表
    - 支持分页
    - 支持按类型筛选

- 数据结构设计：
  - 优化Node结构
  - 添加ImportResult结构
  - 实现节点去重逻辑

### 5.2 节点测速功能
- 实现节点测速功能，包括延迟测试和下载速度测试
- 数据结构设计：
  * SpeedTestResult：测速结果统计
  * SpeedTestConfig：测速配置参数
  * SpeedTestStats：测速过程统计
- 核心功能：
  * 并发测试多个节点
  * 先测试延迟，延迟合格后测试下载速度
  * 实时更新测试进度
  * 保存测试结果
- API接口：
  * POST /api/nodes/test：测试节点速度
    - 请求参数：
      * max_latency：最大延迟阈值
      * test_url：测速URL
      * timeout：超时时间
      * concurrent：并发数
    - 返回数据：
      * 测试结果统计
      * 节点测试详情
- 技术要点：
  * 使用goroutine实现并发测试
  * 使用channel进行任务分发和结果收集
  * 实现进度追踪和统计
  * 异常处理和日志记录

## 6. [2024-02-27] 订阅历史记录功能实现

### 6.1 数据结构设计
- 实现订阅历史记录结构（SubscriptionHistory）：
  - 历史记录ID
  - 订阅ID
  - 操作类型
  - 节点数量
  - 创建时间
  - 详细信息

### 6.2 操作类型支持
- 导入订阅（import）
- 更新订阅（update）
- 删除订阅（delete）
- 生成订阅（generate）

### 6.3 功能特性
- 自动记录订阅相关操作
- 持久化存储历史记录
- 支持查询历史记录
- 记录操作详细信息
- 记录节点数量变化

### 6.4 技术实现
- 使用 JSON 格式存储历史记录
- 实现线程安全的数据操作
- 集成到现有订阅服务中
- 添加日志记录支持
- 优化文件存储结构

## 7. [2024-02-27] 状态监控功能实现

### 7.1 节点状态监控
- 实现节点状态统计：
  * 总节点数：一键整合中的节点总数
  * 当前节点：筛选后生成订阅文件中包含的节点数
  * 慢速节点：筛选节点中，不符合条件的节点数
  * 故障节点：测速节点中，延迟大于400ms的节点数

### 7.2 订阅文件监控
- 显示最新订阅文件的本地地址：
  * 显示最新的sub.yaml本地地址
  * 显示最新的Sub-Input-MM-DD-HH-mm.yaml本地地址
- 历史记录功能：
  * 保存近三次的订阅文件记录
  * 记录包含：文件名、本地地址、生成时间、节点数量

### 7.3 API接口
- GET /api/status：获取系统状态
  * 返回节点状态统计
  * 返回最新文件地址
  * 返回历史记录列表
  * 返回最后更新时间

### 7.4 技术实现
- 使用互斥锁保证并发安全
- 实现历史记录的自动清理（只保留最近三条）
- 支持实时状态更新
- 提供完整的状态监控数据结构


## 8. [2024-02-27] 自动化任务功能

### 新增功能
8.1 定时任务管理
   - 支持创建、更新、删除和查询定时任务
   - 支持设置任务执行周期（使用 Cron 表达式）
   - 支持启用/禁用任务
   - 支持任务超时控制（默认10分钟）

8.2 自动化任务类型
   - 订阅更新任务：定期自动更新所有订阅
   - 节点测速任务：定期自动测试所有节点

8.3 任务执行记录
   - 记录任务执行状态和结果
   - 支持查看任务执行历史
   - 任务执行结果与系统状态集成
   - 详细的任务执行日志：
     * 任务开始日志
     * 执行成功日志（包含执行时长）
     * 执行失败日志（包含错误信息）
     * 执行超时日志（包含超时设置）

### API 接口
8.4 任务管理接口
   - POST /api/tasks - 创建新任务
   - GET /api/tasks - 获取任务列表
   - GET /api/tasks/:id - 获取单个任务详情
   - PUT /api/tasks/:id - 更新任务配置
   - DELETE /api/tasks/:id - 删除任务

### 技术实现
8.5 调度器服务 (SchedulerService)
   - 使用 cron 包实现定时任务调度
   - 支持动态管理任务
   - 线程安全的任务管理
   - 任务执行超时控制
   - 详细的执行日志记录

8.6 数据结构
   - Task: 任务配置信息
   - TaskResult: 任务执行结果
   - TaskType: 任务类型枚举
   - TaskStatus: 任务状态枚举

8.7 日志记录
   - 使用结构化日志记录任务执行情况
   - 记录字段：
     * taskId: 任务ID
     * taskName: 任务名称
     * taskType: 任务类型
     * status: 执行状态
     * duration: 执行时长
     * error: 错误信息（如果有）
     * timeout: 超时设置

## 9. [2024-02-27] 日志系统优化

### 9.1 日志结构优化
- 统一的日志条目结构（LogEntry）：
  * 时间戳
  * 日志级别
  * 消息内容
  * 详细信息
  * 代码位置
  * 额外数据（JSON格式）

### 9.2 日志类型完善
9.2.1 业务操作日志：
   - 订阅导入日志：记录订阅名称和节点数量
   - 订阅整合日志：记录整合的订阅数量
   - 订阅删除日志：记录被删除的订阅名称
   - 节点测速日志：记录总节点数、延迟测速节点数、丢弃节点数、下载测速节点数
   - 节点优选日志：记录筛选条件和符合条件的节点数量
   - 优选订阅日志：记录生成的订阅地址

9.2.2 任务执行日志：
   - 任务开始日志：记录任务ID、名称和类型
   - 任务成功日志：记录执行时长和结果
   - 任务失败日志：记录错误信息和堆栈跟踪
   - 任务超时日志：记录超时时间和执行时长

9.2.3 错误处理日志：
   - 解析错误日志：记录订阅名称、节点类型和具体错误
   - 系统错误日志：记录错误位置和详细信息

### 9.3 技术实现改进
9.3.1 日志存储：
   - 内存缓存最新日志（默认1000条）
   - 文件持久化存储（JSON格式）
   - 自动清理过期日志

9.3.2 性能优化：
   - 使用互斥锁保证并发安全
   - 异步写入文件
   - 批量处理日志

9.3.3 日志查询：
   - 支持按级别过滤
   - 支持按时间范围查询
   - 支持按类型筛选

9.3.4 代码位置追踪：
   - 自动记录日志产生的代码位置
   - 包含文件名和行号
   - 便于问题定位和调试


## 10. [2024-02-27] 前端实现规划

### 10.1 技术栈选型
- 框架：Vue 3 + TypeScript
- UI组件库：Element Plus
- 状态管理：Pinia
- 构建工具：Vite
- HTTP客户端：Axios
- 代码规范：ESLint + Prettier

### 10.2 项目结构
```
frontend/
├── src/
│   ├── api/          # API接口定义
│   ├── assets/       # 静态资源
│   ├── components/   # 公共组件
│   ├── layouts/      # 布局组件
│   ├── router/       # 路由配置
│   ├── stores/       # 状态管理
│   ├── styles/       # 全局样式
│   ├── types/        # TypeScript类型定义
│   ├── utils/        # 工具函数
│   └── views/        # 页面组件
└── tests/            # 测试文件
```

### 10.3 页面规划
10.3.1 订阅管理页面（/subscriptions）
   - 订阅列表展示
   - 导入订阅表单
   - 订阅详情展示
   - 订阅删除确认
   - 订阅合并操作

10.3.2 节点管理页面（/nodes）
   - 节点列表展示
   - 节点测速操作
   - 测速结果展示
   - 节点筛选配置
   - 优选结果展示

10.3.3 系统状态页面（/status）
   - 节点状态统计
   - 最新文件地址
   - 历史记录列表
   - 系统运行状态

10.3.4 任务管理页面（/tasks）
   - 任务列表展示
   - 任务创建表单
   - 任务配置修改
   - 任务执行状态

10.3.5 系统日志页面（/logs）
   - 日志实时展示
   - 日志级别筛选
   - 日志类型筛选
   - 日志时间筛选

### 10.4 组件设计
10.4.1 公共组件
   - 页面布局组件（BaseLayout）
   - 导航菜单组件（NavMenu）
   - 状态标签组件（StatusTag）
   - 确认对话框组件（ConfirmDialog）
   - 加载动画组件（LoadingSpinner）

10.4.2 业务组件
   - 订阅卡片组件（SubscriptionCard）
   - 节点列表组件（NodeList）
   - 测速进度组件（SpeedTestProgress）
   - 状态统计卡片（StatusCard）
   - 日志展示组件（LogViewer）

### 10.5 功能实现顺序
10.5.1 第一阶段：基础框架搭建
   - 项目初始化
   - 路由配置
   - 状态管理
   - API封装
   - 布局实现

10.5.2 第二阶段：核心功能实现
   - 订阅管理功能
   - 节点管理功能
   - 系统状态展示
   - 任务管理功能

10.5.3 第三阶段：优化和完善
   - 日志系统实现
   - 数据可视化
   - 主题定制
   - 响应式适配

### 10.6 交互设计
10.6.1 全局交互
   - 顶部导航栏固定
   - 侧边菜单可折叠
   - 页面加载状态提示
   - 操作结果反馈

10.6.2 数据展示
   - 表格数据分页
   - 列表懒加载
   - 数据实时更新
   - 状态图标提示

10.6.3 操作反馈
   - 操作确认提示
   - 错误信息展示
   - 成功提示动画
   - 进度条反馈

### 10.7 性能优化
10.7.1 代码层面
   - 组件懒加载
   - 路由懒加载
   - 虚拟滚动
   - 防抖节流

10.7.2 构建优化
   - 代码分割
   - 资源压缩
   - 缓存优化
   - Tree Shaking

### 10.8 开发规范
10.8.1 代码规范
   - ESLint配置
   - Prettier配置
   - TypeScript规范
   - 命名规范

10.8.2 提交规范
   - Git提交规范
   - 分支管理规范
   - 版本发布规范
   - 文档更新规范

## 11. [2024-02-28] 前端功能实现

### 11.1 状态监控页面
- 系统运行状态展示
  * CPU使用率监控
  * 内存使用统计
  * 运行时间显示
- 代理状态监控
  * 连接数统计
  * 实时流量统计
  * 当前节点信息
- 定时任务状态展示
  * 任务执行状态
  * 下次执行时间
  * 历史执行记录
- 实时刷新功能
  * 自动定时刷新
  * 手动刷新按钮
  * 刷新状态提示

### 11.2 订阅管理页面
- 订阅列表功能
  * 订阅基本信息展示
  * 节点数量统计
  * 最后更新时间
- 订阅操作功能
  * 添加新订阅
  * 删除订阅
  * 更新订阅
- 订阅状态展示
  * 更新状态标识
  * 错误提示展示
  * 操作结果反馈

### 11.3 优选节点页面
- 节点筛选功能
  * 延迟阈值设置
  * 速度阈值设置
  * 实时筛选统计
- 节点列表展示
  * 节点基本信息
  * 延迟和速度显示
  * 状态标签展示
- 节点排序功能
  * 延迟排序
  * 速度排序
  * 多列排序支持
- 优选订阅生成
  * 生成订阅文件
  * 订阅地址展示
  * 节点数量统计

### 11.4 系统设置页面
- 基本设置
  * 更新间隔配置
  * 测试超时设置
  * 并发数量控制
- 代理设置
  * 监听地址配置
  * 端口号设置
  * 系统代理开关
- 订阅设置
  * 自动更新配置
  * 更新时间设置
  * 更新间隔选择
- 设置管理
  * 设置保存功能
  * 设置验证
  * 实时生效支持

### 11.5 运行日志页面
- 日志展示功能
  * 实时日志更新
  * 分页加载支持
  * 自动滚动控制
- 日志筛选功能
  * 关键词搜索
  * 日期范围筛选
  * 日志级别过滤
- 日志管理功能
  * 日志导出
  * 日志清理
  * 批量操作支持
- 日志展示优化
  * 彩色日志级别
  * 格式化时间显示
  * 自动换行处理

### 11.6 技术优化
- 统一页面布局
  * 响应式设计
  * 统一页面容器
  * 统一卡片样式
- 组件封装
  * 公共组件抽取
  * 业务组件封装
  * 组件复用优化
- 类型系统完善
  * TypeScript 类型定义
  * 接口类型规范
  * 类型检查严格化
- 错误处理机制
  * 统一错误处理
  * 友好错误提示
  * 错误日志记录

### 11.7 待优化项
- 前端性能优化
  * 代码分割
  * 懒加载优化
  * 缓存策略
- UI/UX 体验优化
  * 交互动效
  * 主题定制
  * 移动端适配
- 代码质量优化
  * 代码重构
  * 测试覆盖
  * 文档完善
- 工程化优化
  * 构建优化
  * 部署流程
  * 监控体系

## 12. [2024-02-28] ESLint 配置优化

### 12.1 ESLint 配置重构
- 重写 ESLint 配置，使用新的 flat config 格式
- 优化对 Vue 3 和 TypeScript 的支持
- 修复 `process` 未定义问题，改用 `import.meta.env`
- 禁用 `vue/comment-directive` 规则，解决 Vue 文件注释指令问题

### 12.2 依赖更新
- 添加 `globals` 依赖，支持浏览器和 Node.js 全局变量
- 使用 `--legacy-peer-deps` 解决依赖冲突问题

### 12.3 配置特性
- 分离 JavaScript/TypeScript 和 Vue 文件的配置规则
- 添加对 ECMAScript 2021 特性的支持
- 配置 TypeScript 解析器和插件
- 优化 Vue 3 相关规则配置

### 12.4 规则优化
- 根据环境自动调整 `no-console` 和 `no-debugger` 规则
- 关闭 TypeScript 显式类型边界检查
- 允许使用 `any` 类型
- 关闭组件命名规则限制

